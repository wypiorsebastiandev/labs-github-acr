stages:
  - build
  - push

# Build the Docker image
build_image:
  stage: build
  image: docker:24.0.1
  services:
    - docker:24.0.1-dind
  script:
    - docker build -t $DOCKERHUB_IMAGE:$CI_COMMIT_SHA .
    - docker tag $DOCKERHUB_IMAGE:$CI_COMMIT_SHA $DOCKERHUB_IMAGE:latest
  only:
    - main

# Push the Docker image to Docker Hub
push_image:
  stage: push
  image: docker:24.0.1
  services:
    - docker:24.0.1-dind
  script:
    - echo $DOCKERHUB_PASSWORD | docker login -u $DOCKERHUB_USERNAME --password-stdin
    - docker push $DOCKERHUB_IMAGE:$CI_COMMIT_SHA
    - docker push $DOCKERHUB_IMAGE:latest
  only:
    - main
